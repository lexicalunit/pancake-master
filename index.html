<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type" />
<link rel="stylesheet" type="text/css" href="pancake.css">
<script type="text/javascript">
pancakes = new Array();

function pad(num, size) {
    var s = num + "";
    while (s.length < size)
        s = "0" + s;
    return s;
}

function daystr() {
    var today = new Date();
    var dd = pad(today.getDate(), 2);
    var mm = pad(today.getMonth() + 1, 2);
    var yyyy = today.getFullYear();
    return yyyy + mm + dd;
}

function show(text) {
    var node = document.createTextNode(text);
    var out = document.getElementsByTagName("body")[0];
    out.appendChild(node);
    out.appendChild(document.createElement("br"));
}

function clear() {
    document.getElementsByTagName("body")[0].innerHTML = "";
}

function parseCinema(data) {
    show("Parsing " + data.Cinema.CinemaName + " Data...");

    for(var i = 0; i < data.Cinema.Dates.length; i++) {
        var date_data = data.Cinema.Dates[i];
        for(var j = 0; j < date_data.Films.length; j++) {
            var film_data = date_data.Films[j];
            var is_pancake = film_data.Film.match(/pancake/i);
            if(is_pancake) {
                pancake = {
                    film: film_data.Film // string.capwords(film.lstrip('Master Pancake: ').lower())
                    , film_uid: film_data.FilmId
                    , cinema: data.Cinema.CinemaName
                    // , cinema_url: film_data.,
                    , date: date_data.Date
                    // , time: session_data['SessionTime']
                    // , onsale: onsale
                };
                show(JSON.stringify(pancake));
            }
        }
    }
}

function buildCinema(cinema) {
    show("Fetching " + cinema.CinemaName + " Data...");

    var url = "https://d20ghz5p5t1zsc.cloudfront.net/adcshowtimeJson/CinemaSessions.aspx?cinemaid=" + pad(cinema.CinemaId, 4) + "&callback=parseCinema";
    var script = document.createElement('script');
    script.setAttribute('src', url);
    document.getElementsByTagName('head')[0].appendChild(script);
}

function buildCinemas(cinemas) {
    show("Parsing Cinemas Data...");

    for(var i = 0; i < cinemas.length; i++) {
        var cinema = cinemas[i];
        buildCinema(cinema);
    }
}

function parseMarket(data) {
    show("Parsing Market Data...");

    var cinemas = new Array();
    for(var i = 0; i < data.Market.Cinemas.length; i++) {
        var cinema = data.Market.Cinemas[i];
        var item = {CinemaId: cinema.CinemaId, CinemaName: cinema.CinemaName, CinemaURL: cinema.CinemaURL};
        cinemas.push(item);
    }

    buildCinemas(cinemas);
}

function buildMarket() {
    clear();

    show("Fetching Market Data...");
    var url = "https://d20ghz5p5t1zsc.cloudfront.net/adcshowtimeJson/marketsessions.aspx?date=" + daystr() + "&marketid=" + pad(0, 4) + "&callback=parseMarket";
    var script = document.createElement('script');
    script.setAttribute('src', url);
    document.getElementsByTagName('head')[0].appendChild(script);
}

// show(JSON.stringify(data));

</script>
</head>
<body onload="buildMarket();">
Loading...
</body>
</html>
